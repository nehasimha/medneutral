<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedNeutral - Clinical Note Rewriter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #d5dbdb;
        }

        .results-section {
            display: none;
            margin-top: 40px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 4px solid #667eea;
        }

        .result-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .text-content {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .stigma-highlight {
            background: #ff6b6b;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .replacement-highlight {
            background: #51cf66;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .stats-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }

        .changes-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
        }

        .change-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ff6b6b;
        }

        .change-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .change-details {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 10px;
        }

        .change-arrow {
            color: #7f8c8d;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #51cf66;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MedNeutral</h1>
            <p>AI-Powered Clinical Note Rewriter - Detecting and Replacing Stigmatizing Language</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div class="form-group">
                    <label for="clinical-note">Clinical Note:</label>
                    <textarea id="clinical-note" placeholder="Enter your clinical note here...&#10;&#10;Example:&#10;Patient was adamant about their symptoms and refused to comply with the treatment plan. The patient appeared agitated and uncooperative during the examination."></textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="processNote()">Process Note</button>
                    <button class="btn btn-secondary" onclick="loadSample()">Load Sample</button>
                    <button class="btn btn-secondary" onclick="clearText()">Clear</button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your clinical note...</p>
            </div>

            <div class="results-section" id="results">
                <div class="stats-section">
                    <h3>Analysis Summary</h3>
                    <div class="stats-grid" id="stats-grid">
                        <!-- Stats will be populated here -->
                    </div>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <h3>Original Text</h3>
                        <div class="text-content" id="original-text">
                            <!-- Original text with highlights -->
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <h3>Rewritten Text</h3>
                        <div class="text-content" id="rewritten-text">
                            <!-- Rewritten text with highlights -->
                        </div>
                    </div>
                </div>

                <div class="changes-section" id="changes-section">
                    <h3>Changes Made</h3>
                    <div id="changes-list">
                        <!-- Changes will be listed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function processNote() {
            const text = document.getElementById('clinical-note').value.trim();
            
            if (!text) {
                showError('Please enter a clinical note to process.');
                return;
            }

            showLoading(true);
            hideResults();

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                const result = await response.json();

                if (response.ok) {
                    displayResults(result);
                } else {
                    showError(result.error || 'An error occurred while processing the note.');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayResults(result) {
            // Display stats
            const statsGrid = document.getElementById('stats-grid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${result.has_stigma ? 'Yes' : 'No'}</div>
                    <div class="stat-label">Contains Stigma</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${result.stigma_matches.length}</div>
                    <div class="stat-label">Stigma Instances</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${result.num_changes}</div>
                    <div class="stat-label">Changes Made</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${result.stigma_categories.length}</div>
                    <div class="stat-label">Stigma Categories</div>
                </div>
            `;

            // Display original text with highlights
            const originalText = document.getElementById('original-text');
            let highlightedOriginal = result.original_text;
            
            // Highlight stigmatizing words in original text
            result.stigma_matches.forEach(match => {
                const regex = new RegExp(`(${escapeRegExp(match.text)})`, 'gi');
                highlightedOriginal = highlightedOriginal.replace(regex, '<span class="stigma-highlight">$1</span>');
            });
            
            originalText.innerHTML = highlightedOriginal;

            // Display rewritten text with highlights
            const rewrittenText = document.getElementById('rewritten-text');
            let highlightedRewritten = result.rewritten_text;
            
            // Highlight replacements in rewritten text
            result.changes_made.forEach(change => {
                const regex = new RegExp(`(${escapeRegExp(change.replacement)})`, 'gi');
                highlightedRewritten = highlightedRewritten.replace(regex, '<span class="replacement-highlight">$1</span>');
            });
            
            rewrittenText.innerHTML = highlightedRewritten;

            // Display changes
            const changesList = document.getElementById('changes-list');
            if (result.changes_made.length > 0) {
                changesList.innerHTML = result.changes_made.map(change => `
                    <div class="change-item">
                        <h4>${change.category} Category</h4>
                        <div class="change-details">
                            <span class="stigma-highlight">${change.original}</span>
                            <span class="change-arrow">→</span>
                            <span class="replacement-highlight">${change.replacement}</span>
                        </div>
                        <small>Context: "${change.context}"</small>
                    </div>
                `).join('');
            } else {
                changesList.innerHTML = '<p>No stigmatizing language detected.</p>';
            }

            showResults();
        }

        function loadSample() {
            const sampleText = `Patient was adamant about their symptoms and refused to comply with the treatment plan. The patient appeared agitated and uncooperative during the examination. They claimed to be in severe pain but seemed to be exaggerating their symptoms. The patient was poorly groomed and appeared to be drug seeking.`;
            document.getElementById('clinical-note').value = sampleText;
        }

        function clearText() {
            document.getElementById('clinical-note').value = '';
            hideResults();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showResults() {
            document.getElementById('results').style.display = 'block';
        }

        function hideResults() {
            document.getElementById('results').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(errorDiv, mainContent.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Load system stats on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/stats');
                const stats = await response.json();
                console.log('System stats:', stats);
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        });
    </script>
</body>
</html>
